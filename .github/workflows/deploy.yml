name: Full Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Runnerの作業エリアでGoをビルド
      - name: Build Go Server
        run: |
          # フォルダ名指定ではなく「.」でビルド（前回のundefinedエラー対策）
          go build -o main.exe .

      # 2. 古いプロセスを止める（デスクトップで動いているもの）
      - name: Stop Old Server
        run: |
          # 以前起動したサーバーが残っていれば終了させる
          Stop-Process -Name "main" -ErrorAction SilentlyContinue

      # 3. ビルドしたファイルと静的ファイルをデスクトップへ同期（デプロイ）
      - name: Sync to Desktop
        run: |
          # Goサーバーの本体をコピー
          Copy-Item -Path "./main.exe" -Destination "C:/Users/rinwa/Desktop/programing/go_server/main.exe" -Force
          
          # ティラノスクリプトのファイルをコピー (TyranoEduフォルダへ)
          # 注：リポジトリが分かれている場合は、該当するリポジトリのみで設定してください
          # Copy-Item -Path "*" -Destination "C:/Users/rinwa/Desktop/programing/TyranoEdu" -Recurse -Force

      # 4. デスクトップのフォルダから新しいサーバーを起動
      - name: Start New Server
        run: |
          cd C:/Users/rinwa/Desktop/programing/go_server
          Start-Process -FilePath "./main.exe" -WindowStyle Hidden