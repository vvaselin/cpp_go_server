name: Full Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ティラノスクリプトの更新
      - name: Sync TyranoEdu
        run: |
          # パスが統一されていることを前提にコピー
          Copy-Item -Path "*" -Destination "C:/Users/rinwa/Desktop/programing/TyranoEdu" -Recurse -Force

      # 2. Goサーバーのビルドと再起動
      - name: Rebuild and Restart Go Server
        run: |
          cd C:/Users/rinwa/Desktop/programing/cpp_go_server
          
          # 実行中の古いサーバーを止める
          Stop-Process -Name "main" -ErrorAction SilentlyContinue
          
          # 【修正ポイント】ファイル名指定ではなく「.」でディレクトリ全体をビルドする
          go build -o main.exe .
          
          # ビルドが成功したか確認してから起動
          if (Test-Path "./main.exe") {
              Start-Process -FilePath "./main.exe" -WindowStyle Hidden
          } else {
              Write-Error "Build failed: main.exe was not created."
              exit 1
          }